# 2025-11-16
- リポジトリはFUSEベースのlitファイルシステム型ソース管理を実装するという仕様。
- 仕様内容を`doc/spec.md`に整理。
- 仕様レビューで不足していたFUSEイベント網羅、CRDT設計要件、チェックポイント戦略に加え、テキスト/blob分類とblobの単純バージョニング管理、`lit`コマンド体系(サブコマンド表)と編集単位(低レベルイベント→内部操作→ユーザー向けブロック、コミット無し・ラベル運用)を`doc/spec.md`へ反映。blobは`close`を主トリガーとし、`fsync`/`flush`/アイドルタイムアウト/明示コマンドで早期確定できる仕様にした。さらにgRPCベースの`lit relay`やP2P同期、リレーAPI仕様(セッション/ストリーム/認証)と、ローカル/リモートのストレージ抽象(`StorageBackend`トレイト、Fs/S3/Mem実装方針)を定義。
- `doc/spec.md`にrelay proto抜粋と`proto/relay.proto`での管理方針、`lit-storage` crate構想(backend trait/FS/S3/Mem)を追記。実装として`proto/relay.proto`とRust crateスケルトン(FsBackend/MemBackend)を作成。
- gRPCビルドパイプライン(tonic-build)を導入し、`lit-relay`バイナリcrateを追加。`lit relay`サーバ骨格としてOpenSession/StreamOps/FetchSnapshot/ListRefs/Heartbeatを実装し、`StorageBackend`(Fs/Mem)経由で操作ログを永続化。
- `cargo test`でworkspace全体(lit-relay含む)をビルドし、Fs/Memバックエンドのユニットテストも通過。
- lit-relayにSnapshot/ListRefs実体保存・列挙、Blob/Snapshotメタの永続化、Bearerトークン認証を実装。StorageBackendの`list_objects`は再帰検索対応。
- `lit` CLIをRustで実装し、gRPCクライアント(tonic)から`OpenSession`/`StreamOps`/`Heartbeat`/`ListRefs`を呼び出す`lit sync`コマンドを追加。CLI/サーバともに`authorization: Bearer`ヘッダを扱えるようにした。
- `cargo test`でCLI/relay/storageを含むworkspace全体を再テストし成功。
- `lit sync --send-file`でローカルファイルをOperationとして送信できるようにし、blob扱い時はrelay側で`blobs/<path>/<version>`に保存。`lit blob-fetch`コマンドと`FetchBlob` RPCを追加し、バージョン指定でblobを取得可能にした。
- Relay/CLIの変更後に`cargo fmt`/`cargo test`を実行し、全ターゲットがグリーンであることを確認。
- `make install`で`lit` CLIと`lit-relay`を`cargo install --path`経由でローカル環境に入れられるMakefileを追加。
- Makefileに`test`(fmt+test一括)と`relay`(デフォルト設定でリレー起動)ターゲットを追加し、開発・起動フローを簡略化。
- Rust toolchain(rustup)を導入し、`lit-storage`のFs/Mem backendに対する単体テストを`cargo test -p lit-storage`で実行。
- `lit init [path]`を実装し、`fuse-overlayfs`を使って指定ディレクトリを`lower/upper/work`に退避→FUSEマウントする初期化フローを追加。ワークスペース情報は`~/.lit/workspaces/<id>`に記録。
- Makefileで`CARGO_TARGET_DIR`を`~/.cache/lit/target`に固定し、`cache-dir`依存でビルドキャッシュを共有。さらに`lit version`サブコマンドを追加してCLIのバージョンを即確認できるようにした。
- `lit init`を`lit on`に改名し、`lit off [path]`で`fusermount3 -u`を呼び出すサブコマンドを追加。`lit`単体起動で現在のWORKSPACE状態(ON/OFF/パス)を表示できるようにし、`lit on`はマウント完了をポーリングしてから返す仕様。`lit off`時にはマウントポイント→lower→ターゲットへファイルを同期し、再度`lit on`しても内容を引き継げるようにした。さらに`lit add`/`lit rm`を実装し、watch list(`watch.json`)に登録したパスのみ管理する方式に変更。`lit log [path]`でwatch対象の現在差分を`diff`＋pagerで確認でき、同時にCRDTドキュメント(`lit-crdt`/Automergeベース)を更新するようにした。
- FUSEのPID/UIDを取得するには`fuse-overlayfs`ではなく自前のlibfuse実装が必要。今後の切り替え手順メモ:
  1. `lit-fs`のようなデーモンcrateを新設し、libfuse(high-level API)で`read/write/open/release`ハンドラを実装する。
  2. `lit on`はfuse-overlayfs起動ではなくRust製FUSEデーモンをspawnし、UNIXソケット経由でCLIと連携。
  3. ハンドラ内で`fuse_req_ctx(req)->pid/uid`を取得し、操作ログ(Automergeやwatch list)へPIDを付与する。
  4. 既存のlower/upper/work同期ロジックは新デーモン側へ移植し、CLIはmount/unmount＋設定管理に集中させる。
  5. 段階的にfuse-overlayfs依存を排除し、PIDトレースやファイル監査の要求を満たす。
- 上記方針に沿って`lit-fs`(fuserベース)を追加し、`lit on/off`は自前デーモンをspawn/アンマウントする構成へ切り替え済み。`lit-fs`は簡易パススルーFSとしてPID付きログが取得できる。
