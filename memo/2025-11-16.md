# 2025-11-16
- リポジトリはFUSEベースのlitファイルシステム型ソース管理を実装するという仕様。
- 仕様内容を`doc/spec.md`に整理。
- 仕様レビューで不足していたFUSEイベント網羅、CRDT設計要件、チェックポイント戦略に加え、テキスト/blob分類とblobの単純バージョニング管理、`lit`コマンド体系(サブコマンド表)と編集単位(低レベルイベント→内部操作→ユーザー向けブロック、コミット無し・ラベル運用)を`doc/spec.md`へ反映。blobは`close`を主トリガーとし、`fsync`/`flush`/アイドルタイムアウト/明示コマンドで早期確定できる仕様にした。さらにgRPCベースの`lit relay`やP2P同期、リレーAPI仕様(セッション/ストリーム/認証)と、ローカル/リモートのストレージ抽象(`StorageBackend`トレイト、Fs/S3/Mem実装方針)を定義。
- `doc/spec.md`にrelay proto抜粋と`proto/relay.proto`での管理方針、`lit-storage` crate構想(backend trait/FS/S3/Mem)を追記。実装として`proto/relay.proto`とRust crateスケルトン(FsBackend/MemBackend)を作成。
- gRPCビルドパイプライン(tonic-build)を導入し、`lit-relay`バイナリcrateを追加。`lit relay`サーバ骨格としてOpenSession/StreamOps/FetchSnapshot/ListRefs/Heartbeatを実装し、`StorageBackend`(Fs/Mem)経由で操作ログを永続化。
- `cargo test`でworkspace全体(lit-relay含む)をビルドし、Fs/Memバックエンドのユニットテストも通過。
- lit-relayにSnapshot/ListRefs実体保存・列挙、Blob/Snapshotメタの永続化、Bearerトークン認証を実装。StorageBackendの`list_objects`は再帰検索対応。
- `lit` CLIをRustで実装し、gRPCクライアント(tonic)から`OpenSession`/`StreamOps`/`Heartbeat`/`ListRefs`を呼び出す`lit sync`コマンドを追加。CLI/サーバともに`authorization: Bearer`ヘッダを扱えるようにした。
- `cargo test`でCLI/relay/storageを含むworkspace全体を再テストし成功。
- `lit sync --send-file`でローカルファイルをOperationとして送信できるようにし、blob扱い時はrelay側で`blobs/<path>/<version>`に保存。`lit blob-fetch`コマンドと`FetchBlob` RPCを追加し、バージョン指定でblobを取得可能にした。
- Relay/CLIの変更後に`cargo fmt`/`cargo test`を実行し、全ターゲットがグリーンであることを確認。
- `make install`で`lit` CLIと`lit-relay`を`cargo install --path`経由でローカル環境に入れられるMakefileを追加。
- Makefileに`test`(fmt+test一括)と`relay`(デフォルト設定でリレー起動)ターゲットを追加し、開発・起動フローを簡略化。
- Rust toolchain(rustup)を導入し、`lit-storage`のFs/Mem backendに対する単体テストを`cargo test -p lit-storage`で実行。
- `lit init [path]`を実装し、`fuse-overlayfs`を使って指定ディレクトリを`lower/upper/work`に退避→FUSEマウントする初期化フローを追加。ワークスペース情報は`~/.lit/workspaces/<id>`に記録。
- Makefileで`CARGO_TARGET_DIR`を`~/.cache/lit/target`に固定し、`cache-dir`依存でビルドキャッシュを共有。さらに`lit version`サブコマンドを追加してCLIのバージョンを即確認できるようにした。
- `lit init`を`lit on`に改名し、`lit off [path]`で`fusermount3 -u`を呼び出すサブコマンドを追加。`lit`単体起動で現在のWORKSPACE状態(ON/OFF/パス)を表示できるようにし、`lit on`はマウント完了をポーリングしてから返す仕様。`lit off`時にはマウントポイント→lower→ターゲットへファイルを同期し、再度`lit on`しても内容を引き継げるようにした。さらに`lit add`/`lit rm`を実装し、watch list(`watch.json`)に登録したパスのみ管理する方式に変更。`lit log [path]`でwatch対象の現在差分を`diff`＋pagerで確認でき、同時にCRDTドキュメント(`lit-crdt`/Automergeベース)を更新するようにした。
- FUSEのPID/UIDを取得するには`fuse-overlayfs`ではなく自前のlibfuse実装が必要。今後の切り替え手順メモ:
  1. `lit-fs`のようなデーモンcrateを新設し、libfuse(high-level API)で`read/write/open/release`ハンドラを実装する。
  2. `lit on`はfuse-overlayfs起動ではなくRust製FUSEデーモンをspawnし、UNIXソケット経由でCLIと連携。
  3. ハンドラ内で`fuse_req_ctx(req)->pid/uid`を取得し、操作ログ(Automergeやwatch list)へPIDを付与する。
  4. 既存のlower/upper/work同期ロジックは新デーモン側へ移植し、CLIはmount/unmount＋設定管理に集中させる。
  5. 段階的にfuse-overlayfs依存を排除し、PIDトレースやファイル監査の要求を満たす。
- 上記方針に沿って`lit-fs`(fuserベース)を追加し、`lit on/off`は自前デーモンをspawn/アンマウントする構成へ切り替え済み。`lit-fs`は簡易パススルーFSとしてPID付きログが取得できる。
- lit on/offの内部構造を改善。ターゲットの実体は`lower`に退避しつつ、作業コピーを`upper`に複製して`lit-fs`は`upper`をマウントするように変更したため、`lower`はベースライン、`upper`はワーキングツリーとして独立した状態を維持できる。これにより`lit log`が常に差分0になる問題を解消。
- `lit off`は`upper`からターゲットへ書き戻すだけにし、`lower`は上書きしない構成に整理。新規に`hydrate_upper_from_lower`/`sync_upper_to_target`ヘルパを追加してディレクトリ同期をわかりやすくした。
- `make test`でworkspace全体のfmt/testを実行、さらに`make install`→`lit on/off`/`lit add`/`lit log`を`./tmp/test`で確認し、差分表示とマウント解除後のファイル復元が期待通りであることを確認した。
- `lit drop <path>`サブコマンドを実装。マウント中/非マウント時を問わず対象のワーキングツリー(`mountpoint`)、ベースライン(`lower`)、作業コピー(`upper`)とCRDTドキュメントを削除し、watch list からも自動で外すことで「ファイル本体と履歴の完全破棄」が出来るようにした。READMEのコマンド一覧にも追記。
- `tmp/test1`/`tmp/test2`でrelay同期を検証。`lit-relay --listen 127.0.0.1:50051`を`tmp/relay-data`配下で起動し、test1から`lit sync --send-file a.txt --blob`を実行→`lit blob-fetch --path a.txt --version 00000000000000000001`でtest2側に取得。逆方向も同様にb.txtを送信し、双方でrelay越しにバージョンを共有できることを確認した。
- `lit tag <name> [message]`と`lit reset <name>`を実装。ワークスペース配下(`~/.lit/workspaces/<id>/tags/<name>`)にツリーをフルコピーし、メタ情報(meta.json)へメッセージと作成日時を残す。`reset`はタグのスナップショットを`upper`/`lower`へ反映することで、FUSEマウント配下も即座に巻き戻せるようにした。READMEのコマンド表も更新。
- `lit tag`を引数なしで実行すると`~/.lit/workspaces/<id>/tags`内のメタ情報を読み取り、作成時刻/タグ名/メッセージを一覧表示する機能を追加。タグ時刻はローカルタイムの`YYYY-MM-DD HH:MM:SS`形式で出力するようにした。
- `lit lock <path> [--timeout SEC] [-m MSG]`を追加。ロック情報は`locks.json`に保存し、FUSEデーモン起動時に`--locks-file`を渡して`lit-fs`側で監視する。`lit-fs`ではロック状態をキャッシュし、write/mkdir/create/unlinkの前にUID/PIDを照合して一致しない場合はEACCESで拒否しつつメッセージをログに出力する。タイムアウト付きロックは期限が切れると自動で無効化される。
- `lit lock [path]`でパス指定時は従来通りロック、無指定時は`locks.json`の内容を`YYYY-MM-DD HH:MM:SS <path> uid=<u> pid=<p> [msg]`形式で一覧表示するようにした。`lit unlock <path>`も追加し、自分のUID/PIDで取得したロックを解除できる。
- ロック解除は、元のPIDが生存していない場合に同じUIDであれば別PIDから`lit unlock`可能にした。`/proc/<pid>`の有無で判定し、生存中のPIDについては従来通り解除不可のまま。合わせて`lit lock`も、同一UIDで死んだPIDのロックは取り直せるようにした。
- `doc/spec.md`のコマンド表とワークスペース仕様を最新実装( `lit on/off`・watch list・tag/reset・lock/unlock等)に合わせて刷新。`lit-fs`のlower/upper構造や`locks.json`によるUID/PIDロック強制、タグ/リセットの保存場所を明記した。
- 同一UIDで複数エージェントが作業できるよう、セッションID(`LIT_SESSION_ID`または自動生成)を導入。watch listを共有(`watch.json`)とセッション別(`watch/<session>.json`)に分離し、`lit add/rm --global`切替や`lit log`での和集合処理を実装。`lit lock`/`lit unlock`もセッションIDとPIDの死活監視を反映し、他セッションのロックやPID生存中のロックを誤って解除できないようにした。
- `lit tag`/`lit reset`は他セッションのロックが残っている場合に拒否するガードを追加。さらに`lit log --watch --interval N`で差分をポーリング表示、`lit sync --repeat N`で自動同期できるようにし、README/仕様書にもセッション/ロック/自動化の記述を追記した。
